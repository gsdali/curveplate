name: Sync Issues to Local Mirror

on:
  issues:
    types: [opened, edited, closed, reopened, deleted, labeled, unlabeled]
  schedule:
    # Run daily at midnight UTC to catch any missed updates
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write
  issues: read

jobs:
  sync-issues:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Fetch issues and generate TASKS.md
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Fetch all open issues
            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 100
            });

            // Group by label
            const byLabel = {
              bug: [],
              enhancement: [],
              task: [],
              other: []
            };

            for (const issue of issues) {
              if (issue.pull_request) continue; // Skip PRs

              const labels = issue.labels.map(l => l.name);
              if (labels.includes('bug')) {
                byLabel.bug.push(issue);
              } else if (labels.includes('enhancement')) {
                byLabel.enhancement.push(issue);
              } else if (labels.includes('task')) {
                byLabel.task.push(issue);
              } else {
                byLabel.other.push(issue);
              }
            }

            // Generate markdown
            let md = '# Active Tasks\n\n';
            md += `> Auto-generated from GitHub Issues on ${new Date().toISOString().split('T')[0]}\n\n`;

            const sections = [
              ['Bugs', byLabel.bug],
              ['Features', byLabel.enhancement],
              ['Tasks', byLabel.task],
              ['Other', byLabel.other]
            ];

            for (const [title, items] of sections) {
              if (items.length === 0) continue;

              md += `## ${title}\n\n`;
              for (const issue of items) {
                const priority = issue.labels.find(l => l.name.startsWith('priority:'))?.name || '';
                md += `- [ ] [#${issue.number}](${issue.html_url}) ${issue.title}`;
                if (priority) md += ` (${priority})`;
                md += '\n';
              }
              md += '\n';
            }

            // Ensure docs directory exists
            if (!fs.existsSync('docs')) {
              fs.mkdirSync('docs');
            }

            fs.writeFileSync('docs/TASKS.md', md);
            console.log('Generated docs/TASKS.md');

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/TASKS.md
          git diff --staged --quiet || git commit -m "chore: sync issues to TASKS.md [skip ci]"
          git push
